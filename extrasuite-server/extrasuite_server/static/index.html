<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtraSuite - Internal Authentication Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .copy-btn:hover { opacity: 0.8; }
        .copy-btn:active { transform: scale(0.95); }
        .tab-active { border-bottom: 2px solid #1d4ed8; color: #1d4ed8; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header bar (shown when authenticated) -->
    <header id="header-bar" class="hidden bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-bold text-gray-900">ExtraSuite</h1>
                <span class="text-sm text-gray-500 hidden sm:inline">Internal Authentication Service</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <span id="user-avatar" class="text-white text-sm font-medium"></span>
                    </div>
                    <span id="header-email" class="text-sm text-gray-700 hidden sm:inline"></span>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-3xl mx-auto px-4 py-8">
        <!-- Title for unauthenticated view -->
        <header id="unauth-header" class="mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">ExtraSuite</h1>
            <p class="text-lg text-gray-600">Internal Authentication Service</p>
        </header>

        <main>
            <!-- Loading state -->
            <div id="loading-section" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-8">
                <p class="text-gray-500">Loading...</p>
            </div>

            <!-- Unauthenticated view -->
            <div id="login-section" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-8">
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">About</h2>
                    <p class="text-gray-700 mb-4">
                        ExtraSuite is a headless authentication service that enables CLI tools and LLM agents to securely access Google Workspace APIs (Sheets, Docs, Drive). It handles OAuth authentication and generates short-lived service account tokens, so developers don't need to manage credentials manually.
                    </p>
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <p class="text-amber-800">
                            This service is for <strong>internal use only</strong> by employees of think41.com, recruit41.com, and mindlap.dev. Unauthorized access is prohibited.
                        </p>
                    </div>
                </section>

                <section>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Employee Login</h2>
                    <p class="text-gray-700 mb-4">
                        Sign in with your company Google account to view your AI assistant details.
                    </p>
                    <a href="/api/token/auth?port=9999"
                       class="inline-block px-6 py-3 bg-gray-900 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        Sign in with Google
                    </a>
                    <p class="text-sm text-gray-500 mt-3">
                        Note: After signing in, you'll be redirected back to this page.
                    </p>
                </section>
            </div>

            <!-- Authenticated view -->
            <div id="user-section" class="hidden">
                <!-- Service Account Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex items-start justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Your AI Assistant</h2>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-700 mb-2">Service Account Email:</p>
                        <div class="flex items-center gap-2">
                            <code id="service-account-email" class="flex-1 bg-blue-100 px-3 py-2 rounded text-blue-900 font-mono text-sm break-all"></code>
                            <button onclick="copyToClipboard('service-account-email')" class="copy-btn px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">
                                Copy
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-700 mb-2 font-medium">Grant Access to Your Documents</p>
                        <p class="text-gray-600 text-sm">
                            To let Claude or Codex read and edit your Google Sheets, Docs, or Slides, share them with your service account email above. Once shared, your AI assistant can access them on your behalf.
                        </p>
                    </div>
                </div>

                <!-- Install Skill Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Install the Skill</h2>
                    <p class="text-gray-700 mb-4">
                        Run this command in your terminal to enable Google Sheets access in Claude Code or Codex:
                    </p>

                    <!-- OS Tabs -->
                    <div class="border-b border-gray-200 mb-4">
                        <div class="flex gap-4">
                            <button id="tab-mac" onclick="showTab('mac')" class="px-3 py-2 text-sm font-medium tab-active">
                                macOS / Linux
                            </button>
                            <button id="tab-windows" onclick="showTab('windows')" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                                Windows (PowerShell)
                            </button>
                        </div>
                    </div>

                    <!-- macOS/Linux command -->
                    <div id="cmd-mac" class="relative">
                        <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                            <pre id="install-cmd-mac" class="text-green-400 font-mono text-sm whitespace-pre-wrap break-all"></pre>
                        </div>
                        <button onclick="copyCommand('mac')" class="copy-btn absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white rounded text-xs hover:bg-gray-600 transition-colors">
                            Copy
                        </button>
                    </div>

                    <!-- Windows command -->
                    <div id="cmd-windows" class="hidden relative">
                        <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                            <pre id="install-cmd-windows" class="text-green-400 font-mono text-sm whitespace-pre-wrap break-all"></pre>
                        </div>
                        <button onclick="copyCommand('windows')" class="copy-btn absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white rounded text-xs hover:bg-gray-600 transition-colors">
                            Copy
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 mt-4">
                        This installs the Google Sheets skill for both Claude Code and Codex. The command is valid for 5 minutes.
                    </p>
                </div>

                <!-- User Directory Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">User Directory</h2>
                    <p class="text-gray-600 text-sm mb-4">
                        View the mapping of employees to their AI assistant service accounts.
                    </p>
                    <a href="/users"
                       class="inline-block px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                        View Directory
                    </a>
                </div>
            </div>
        </main>

        <footer class="mt-12 text-sm text-gray-500">
            <div class="flex flex-wrap gap-4 mb-4">
                <a href="/privacy" class="hover:text-gray-700 underline">Privacy Policy</a>
                <a href="/terms" class="hover:text-gray-700 underline">Terms of Service</a>
            </div>
            <p>&copy; 2026 Think41 Technologies Pvt. Ltd.</p>
        </footer>
    </div>

    <script>
        let downloadToken = null;
        const BASE_URL = window.location.origin;

        async function checkAuth() {
            try {
                const response = await fetch('/api/users/me');

                document.getElementById('loading-section').classList.add('hidden');

                if (response.ok) {
                    const data = await response.json();
                    showAuthenticatedView(data);
                } else {
                    document.getElementById('login-section').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to check auth:', error);
                document.getElementById('loading-section').classList.add('hidden');
                document.getElementById('login-section').classList.remove('hidden');
            }
        }

        async function showAuthenticatedView(data) {
            // Hide unauthenticated header, show header bar
            document.getElementById('unauth-header').classList.add('hidden');
            document.getElementById('header-bar').classList.remove('hidden');
            document.getElementById('user-section').classList.remove('hidden');

            // Set user info in header
            const email = data.email;
            const initials = email.split('@')[0].substring(0, 2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('header-email').textContent = email;

            // Set service account email
            if (data.service_account_email) {
                document.getElementById('service-account-email').textContent = data.service_account_email;
            }

            // Fetch download token and generate install commands
            await generateInstallCommands();
        }

        async function generateInstallCommands() {
            try {
                const response = await fetch('/api/skills/download-token', { method: 'POST' });
                if (!response.ok) {
                    throw new Error('Failed to get download token');
                }
                const data = await response.json();
                downloadToken = data.token;

                const downloadUrl = `${BASE_URL}/api/skills/download?token=${downloadToken}`;

                // macOS/Linux command - downloads, extracts to both directories
                const macCmd = `curl -fsSL "${downloadUrl}" -o /tmp/extrasuite-skills.zip && \\
unzip -o /tmp/extrasuite-skills.zip -d /tmp/extrasuite-skills && \\
mkdir -p ~/.claude/skills ~/.codex/skills && \\
cp -R /tmp/extrasuite-skills/gsheets ~/.claude/skills/ && \\
cp -R /tmp/extrasuite-skills/gsheets ~/.codex/skills/ && \\
rm -rf /tmp/extrasuite-skills /tmp/extrasuite-skills.zip && \\
echo "Skill installed successfully!"`;

                // Windows PowerShell command
                const windowsCmd = `$url = "${downloadUrl}"
$zipPath = "$env:TEMP\\extrasuite-skills.zip"
$extractPath = "$env:TEMP\\extrasuite-skills"
Invoke-WebRequest -Uri $url -OutFile $zipPath
Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
$claudeSkills = "$env:USERPROFILE\\.claude\\skills"
$codexSkills = "$env:USERPROFILE\\.codex\\skills"
New-Item -ItemType Directory -Force -Path $claudeSkills | Out-Null
New-Item -ItemType Directory -Force -Path $codexSkills | Out-Null
Copy-Item -Path "$extractPath\\gsheets" -Destination $claudeSkills -Recurse -Force
Copy-Item -Path "$extractPath\\gsheets" -Destination $codexSkills -Recurse -Force
Remove-Item -Path $zipPath -Force
Remove-Item -Path $extractPath -Recurse -Force
Write-Host "Skill installed successfully!"`;

                document.getElementById('install-cmd-mac').textContent = macCmd;
                document.getElementById('install-cmd-windows').textContent = windowsCmd;

            } catch (error) {
                console.error('Failed to generate install commands:', error);
                document.getElementById('install-cmd-mac').textContent = 'Error: Could not generate install command. Please refresh the page.';
                document.getElementById('install-cmd-windows').textContent = 'Error: Could not generate install command. Please refresh the page.';
            }
        }

        function showTab(tab) {
            // Update tab styles
            document.getElementById('tab-mac').classList.toggle('tab-active', tab === 'mac');
            document.getElementById('tab-mac').classList.toggle('text-gray-500', tab !== 'mac');
            document.getElementById('tab-windows').classList.toggle('tab-active', tab === 'windows');
            document.getElementById('tab-windows').classList.toggle('text-gray-500', tab !== 'windows');

            // Show/hide command blocks
            document.getElementById('cmd-mac').classList.toggle('hidden', tab !== 'mac');
            document.getElementById('cmd-windows').classList.toggle('hidden', tab !== 'windows');
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                // Brief visual feedback could be added here
            });
        }

        function copyCommand(os) {
            const elementId = os === 'mac' ? 'install-cmd-mac' : 'install-cmd-windows';
            copyToClipboard(elementId);
        }

        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
